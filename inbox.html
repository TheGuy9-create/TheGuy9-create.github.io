<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Inbox</title>
<style>
  body { font-family: Arial; background:#f0f8ff; padding:20px; }
  #topbar { display:flex; gap:12px; background:#004080; color:white; padding:10px; border-radius:8px; align-items:center; }
  #chatBox { border:1px solid gray; padding:10px; height:360px; overflow-y:auto; background:white; border-radius:6px; }
  input, button { padding:10px; width:100%; margin-top:10px; border-radius:6px; }
  .message { border-bottom:1px solid #eee; padding:8px 0; display:flex; align-items:center; }
  .message img{ width:28px;height:28px;border-radius:50%; margin-right:8px; object-fit:cover; }

  /* mod menu */
  #modMenu { position:fixed; top:60px; right:20px; background:#111; color:white; padding:12px; border-radius:8px; display:none; z-index:9999; box-shadow:0 0 15px red; }
  #modMenu button{ display:block; width:220px; margin:6px 0; padding:10px; border-radius:6px; border:none; cursor:pointer; font-weight:bold; }
  #screamBtn{ background:red; color:white; } #fartBtn{ background:green; color:white; } #beepBtn{ background:orange; color:black; }

  /* invisible help */
  .invisible-link { color: transparent; text-decoration:none; pointer-events:auto; padding:6px 10px; }
</style>
</head>
<body>
  <div id="topbar">
    <div>Partners</div>
    <div>School ties</div>
    <div>Family set</div>
    <div>Notifications</div>
    <div>Settings</div>
    <!-- OPTION C: visible but transparent clickable HELP -->
    <a href="secretpage.php" class="invisible-link">HELP</a>

    <div style="margin-left:auto; display:flex; align-items:center; gap:8px;">
      <img id="profilePic" src="default.png" alt="profile" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">
      <span id="userDisplay"></span>
      <label for="uploadPic" style="cursor:pointer; color:white;">ðŸ“¤</label>
      <input type="file" id="uploadPic" accept="image/*" style="display:none" onchange="uploadProfilePic()">
      <a href="#" onclick="logout()" style="color:white;">Logout</a>
    </div>
  </div>

  <h2>Inbox</h2>
  <div id="chatBox"></div>
  <input id="messageInput" placeholder="Type a message...">
  <button onclick="sendMessage()">Send</button>

  <audio id="screamSound" src="scary.mp3"></audio>
  <audio id="fartSound" src="fart.mp3"></audio>
  <audio id="beepSound" src="beep.mp3"></audio>

  <!-- mod menu -->
  <div id="modMenu">
    <h3>ðŸ›  Troll Mod Menu</h3>
    <button id="screamBtn" onclick="triggerScream()">ðŸ˜± SCREAM!</button>
    <button id="fartBtn" onclick="triggerFart()">ðŸ’¨ FART!</button>
    <button id="beepBtn" onclick="triggerBeep()">ðŸ“¢ LOUD BEEP!</button>
  </div>

<script>
const username = localStorage.getItem('username');
if(!username) location.href='index.html';
document.getElementById('userDisplay').innerText = username;
document.getElementById('profilePic').src = `uploads/${username}.jpg?${Date.now()}`;

// load messages
function loadMessages(){
  fetch('messages.php').then(r=>r.json()).then(data=>{
    const box = document.getElementById('chatBox'); box.innerHTML='';
    data.forEach(msg=>{
      const div = document.createElement('div'); div.className='message';
      const img = document.createElement('img');
      img.src = `uploads/${msg.user}.jpg?${Date.now()}`; img.onerror = ()=> img.src='default.png';
      div.appendChild(img);
      const inner = document.createElement('div');
      inner.innerHTML = `<strong>${msg.user}</strong>: ${escapeHtml(msg.text)} <small>(${msg.date})</small>`;
      div.appendChild(inner);
      box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
  });
}
function escapeHtml(s){ return (s+'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

function sendMessage(){
  const text = document.getElementById('messageInput').value.trim();
  if(!text) return;
  const date = new Date().toLocaleString();
  fetch('messages.php',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user:username,text,date})})
  .then(()=>{ document.getElementById('messageInput').value=''; loadMessages(); });
}

function uploadProfilePic(){
  const file = document.getElementById('uploadPic').files[0];
  if(!file) return;
  const fd = new FormData(); fd.append('username', username); fd.append('image', file);
  fetch('upload.php',{method:'POST', body:fd}).then(r=>r.text()).then(txt=>{
    if(txt==='OK') document.getElementById('profilePic').src = `uploads/${username}.jpg?${Date.now()}`;
    else alert('Upload failed: '+txt);
  });
}

function logout(){ localStorage.removeItem('username'); location.href='index.html'; }

// Only Test sees the menu buttons and can toggle with Tab
if(username !== 'Test'){
  document.getElementById('modMenu').style.display = 'none';
} else {
  // show mod buttons visible (they will already show, but ensure menu toggles on Tab)
  document.getElementById('screamBtn').style.display = 'block';
  document.getElementById('fartBtn').style.display = 'block';
  document.getElementById('beepBtn').style.display = 'block';
}

// toggle mod menu with Tab for Dzintars only
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Tab' && username === 'Test'){
    e.preventDefault();
    const m = document.getElementById('modMenu');
    m.style.display = (m.style.display === 'block') ? 'none' : 'block';
  }
});

// Trigger functions: call server trigger scripts
function triggerScream(){ fetch('scream.php'); }
function triggerFart(){ fetch('fart.php'); }
function triggerBeep(){ fetch('beep.php'); }

// Poll for triggers and play/reset
function checkTriggers(){
  fetch('data/scream.json').then(r=>r.json()).then(d=>{ if(d.play){ document.getElementById('screamSound').play(); fetch('reset_scream.php'); alert('ðŸ’€ Scream triggered!'); }});
  fetch('data/fart.json').then(r=>r.json()).then(d=>{ if(d.play){ document.getElementById('fartSound').play(); fetch('reset_fart.php'); alert('ðŸ’¨ Fart triggered!'); }});
  fetch('data/beep.json').then(r=>r.json()).then(d=>{ if(d.play){ document.getElementById('beepSound').play(); fetch('reset_beep.php'); alert('ðŸ”” Beep triggered!'); }});
}

// initial
loadMessages();
setInterval(loadMessages, 3000);
setInterval(checkTriggers, 1000);
</script>
</body>
</html>
